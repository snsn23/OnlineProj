<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8">
	<title>MainGame</title>
</head>
<body>

  <script src="enchantjs/enchant.min.js"></script>
  <script src="js/jquery.min.js"></script>
  <script>
  $(document).ready(function(){
  	enchant();							// initialize

		var FPS = 60;
		var START_TIME = 1;//ボールが動くまでの時間
		START_TIME *= FPS;
		var PLAYER_WIDTH = 128;
		var BALL_WIDTH = 128;
		//移動ベクトル
    var vec_x = 1;
    var vec_y = 1;
		//プレイヤー1のスコア
		var score1_count = 0;
		var score2_count = 0;
		//ボールが画面上にいるか
		var ball_dead = false;

		var start_timer = 0;

  	var game = new Core(576, 1024);
		//画像リソース
		game.preload('Image/player1.png','Image/player2.png',
    'Image/ball.png','Image/BackGround.png');
		//音楽リソース
		//game.preload('Sound/main_game.mp3');
  	game.fps = FPS;

    //キー設定
    game.keybind('W'.charCodeAt(0), 'w'); //w -> 32
    game.keybind('A'.charCodeAt(0), 'a'); //a -> 10
    game.keybind('S'.charCodeAt(0), 's'); //s -> 32
    game.keybind('D'.charCodeAt(0), 'd'); //d -> 10

    game.onload = function(){

    	var scene = new Scene();

  		//var bgm = game.assets['Sound/main_game.mp3'];
  		//bgm.play();
  		//bgm.loop = true;

  		//背景表示
  		var bg = new Sprite(576,1024);
  		bg.image = game.assets['Image/BackGround.png'];
  		scene.addChild(bg);

  		//プレイヤー準備
  		var player1 = new Player(576/2,100,0);
  		scene.addChild(player1);
      var player2 = new Player(576/2,800,1);
  		scene.addChild(player2);

			//ボール準備
      var ball = new Ball(576/2,300);
      scene.addChild(ball);

			//スコア準備
			var score1 = new Label("" + score1_count);
			score1.font = "42px Palatino";
			score1.color = '#ffffff';
			score1.moveTo( 500, 900 );
			scene.addChild(score1);

			var score2 = new Label("" + score2_count);
			score2.font = "42px Palatino";
			score2.color = '#ffffff';
			score2.moveTo( 500, 0 );
			scene.addChild(score2);

    	//毎フレーム毎の処理
    	scene.addEventListener('enterframe', function(e) {

  				if (game.input.up === true) player1.walk("w");
  				if (game.input.left  === true) player1.walk("a");
  				if (game.input.down  === true) player1.walk("s");
  				if (game.input.right === true) player1.walk("d");

          if (game.input.w === true) player2.walk("w");
  				if (game.input.a  === true) player2.walk("a");
  				if (game.input.s  === true) player2.walk("s");
  				if (game.input.d === true) player2.walk("d");

					//ボール用壁との当たり判定
          ball.collide_wall(vec_x, vec_y);

					if(start_timer >= START_TIME){
          	ball.move(vec_x, vec_y);
					}
					else{
						start_timer++;
					}

					//スコアの更新
					score1.text = "" + score1_count;
					score2.text = "" + score2_count;

          if(ball.within(player1, BALL_WIDTH)){
            vec_x = -vec_x;
            vec_y = -vec_y;
          }
          if(ball.within(player2, BALL_WIDTH)){
            vec_x = -vec_x;
            vec_y = -vec_y;
          }

					if(ball_dead == true){
						ball.remove(576/2,300);
						ball_dead = false;
						start_timer = 0;
					}


    		});


    		  //シーンを反映
          game.pushScene(scene);
      };

      game.start(); // start your game!

			//プレイヤークラス
			var Player = enchant.Class.create(Sprite, {		//Spriteクラスを継承
					/** コンストラクター */
					initialize: function(x,y,mode) {
						var game = enchant.Game.instance;
						Sprite.call(this, PLAYER_WIDTH, PLAYER_WIDTH);					//Spriteのサイズ定義
						this.x = x;
						this.y = y;
            this.mode = mode;
            if(this.mode == 0){
						this.image = game.assets['Image/player1.png'];		//Spriteに画像をセット
            }
            else{
              this.image = game.assets['Image/player2.png'];
            }
					}
					/** 移動処理メソッド */
					, walk: function(key){
						var step = 10;



						//移動
						switch(key){
							case 'w': this.y -= step; break;
							case 'a': this.x -= step; break;
							case 's': this.y += step; break;
							case 'd': this.x += step; break;
						}
					}
			});

      var Ball = enchant.Class.create(Sprite, {
        /** コンストラクター */
        initialize: function(x,y) {
          var game = enchant.Game.instance;
          Sprite.call(this, BALL_WIDTH, BALL_WIDTH);//Spriteのサイズ定義
          this.x = x;
          this.y = y;

          this.image = game.assets['Image/ball.png'];
        }

        /** 移動処理メソッド */
        , move: function(x, y){

          var speed = 10;
          this.x += x * speed;
          this.y += y * speed;
        }

        //壁との当たり判定
        , collide_wall: function(x, y){
          //反射
          if(this.x <= 0 || 576 - BALL_WIDTH <= this.x ){
            vec_x = -x;
          }
          if(this.y <= 0 - BALL_WIDTH){
            score1_count++;
						ball_dead = true;
          }
					if(1024 + BALL_WIDTH <= this.y ){
						score2_count++;
						ball_dead = true;
					}

        }
				//位置の初期化
				,remove: function(x, y){
					this.x = x;
					this.y = y;
				}

      });

    });

  </script>
</body>
</html>
